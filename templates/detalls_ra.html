<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RA - {{ ra[1] }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>RA - {{ ra[1] }}</h1>
    <button onclick="addEvidence()">Afegir Evidència</button>

    <div class="table-container" id="tableContainer"></div>

    <script>
        async function fetchEvidences() {
            const response = await fetch('/api/evidences');
            const data = await response.json();
            return data;
        }

        function createTable(evidences) {
            const tableContainer = document.getElementById('tableContainer');
            const table = document.createElement('table');
            table.id = 'raTable';

            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const tfoot = document.createElement('tfoot');

            // Encabezado de la tabla
            const headerRow1 = document.createElement('tr');
            headerRow1.innerHTML = `
                <th class="fixed-column" rowspan="8">Criteris d'avaluació</th>
                <th class="fixed-column" rowspan="8">Ponderació</th>
                <th class="fixed-column" rowspan="8">Aconseguit</th>
                <th class="fixed-column" rowspan="8">Progrés</th>
                ${Object.values(evidences).map(evidence => `<th>Descriptor</th>`).join('')}
            `;
            thead.appendChild(headerRow1);

            const headerRow2 = document.createElement('tr');
            headerRow2.innerHTML = `${Object.values(evidences).map(evidence => `<th class="descriptor-header">Excel·lent (4)</th>`).join('')}`;
            thead.appendChild(headerRow2);

            const headerRow3 = document.createElement('tr');
            headerRow3.innerHTML = `${Object.values(evidences).map(evidence => `<th class="descriptor-header">Assolit (4)</th>`).join('')}`;
            thead.appendChild(headerRow3);

            const headerRow4 = document.createElement('tr');
            headerRow4.innerHTML = `${Object.values(evidences).map(evidence => `<th class="descriptor-header">Bé (3)</th>`).join('')}`;
            thead.appendChild(headerRow4);

            const headerRow5 = document.createElement('tr');
            headerRow5.innerHTML = `${Object.values(evidences).map(evidence => `<th class="descriptor-header">Suficient (2)</th>`).join('')}`;
            thead.appendChild(headerRow5);

            const headerRow6 = document.createElement('tr');
            headerRow6.innerHTML = `${Object.values(evidences).map(evidence => `<th class="descriptor-header">Insuficient (1)</th>`).join('')}`;
            thead.appendChild(headerRow6);

            const headerRow7 = document.createElement('tr');
            headerRow7.innerHTML = `${Object.values(evidences).map(evidence => `<th >Evidència</th>`).join('')}`;
            thead.appendChild(headerRow7);

            const headerRow8 = document.createElement('tr');
            headerRow8.innerHTML = `${Object.values(evidences).map(evidence => `<td>${evidence.nom}</td>`).join('')}`;
            thead.appendChild(headerRow8);

            // Cuerpo de la tabla
            const rowsData = [
                { criteri: 'CE A', valor: 20, aconseguit: '20%', progres: '100%' },
                { criteri: 'CE B', valor: 10, aconseguit: '5%', progres: '50%' },
                { criteri: 'CE C', valor: 20, aconseguit: '20%', progres: '100%' },
                { criteri: 'CE D', valor: 50, aconseguit: '50%', progres: '100%' }
            ];

            rowsData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="fixed-column">${data.criteri}</td>
                    <td class="fixed-column"><input type="number" value="${data.valor}"></td>
                    <td class="fixed-column">${data.aconseguit}</td>
                    <td class="fixed-column">${data.progres}</td>
                    ${Object.values(evidences).map(evidence => `<td><input type="number" placeholder="Nota"></td>`).join('')}
                `;
                tbody.appendChild(row);
            });

            // Pie de la tabla
            const footerRow = document.createElement('tr');
            footerRow.innerHTML = `
                <td class="fixed-column">TOTALS</td>
                <td class="fixed-column"><input type="number" value="100" disabled></td>
                <td class="fixed-column">95%</td>
                <td class="fixed-column">88%</td>
                ${Object.values(evidences).map(() => `<td></td>`).join('')}
            `;
            tfoot.appendChild(footerRow);

            table.appendChild(thead);
            table.appendChild(tbody);
            table.appendChild(tfoot);
            tableContainer.appendChild(table);
        }

        function addEvidence() {
            const table = document.getElementById('raTable');
            const headerRows = table.querySelectorAll('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');
            const footerRow = table.querySelector('tfoot tr');

            // Añadir nueva columna al encabezado
            headerRows[0].insertAdjacentHTML('beforeend', `<th>Descriptor</th>`);
            headerRows[1].insertAdjacentHTML('beforeend', `<th>Excel·lent (4)</th>`);
            headerRows[2].insertAdjacentHTML('beforeend', `<th>Assolit (4)</th>`);
            headerRows[3].insertAdjacentHTML('beforeend', `<th>Bé (3)</th>`);
            headerRows[4].insertAdjacentHTML('beforeend', `<th>Suficient (2)`);
            headerRows[5].insertAdjacentHTML('beforeend', `<th>Insuficient (1)`);
            headerRows[6].insertAdjacentHTML('beforeend', `<th>Evidència</th>`);
            headerRows[7].insertAdjacentHTML('beforeend', `<td>Nova Evidència</td>`);

            // Añadir inputs en cada fila del cuerpo
            bodyRows.forEach(row => {
                row.insertAdjacentHTML('beforeend', `<td><input type="number" placeholder="Nota"></td>`);
            });

            // Actualizar la fila total
            footerRow.insertAdjacentHTML('beforeend', `<td></td>`);
        }

        // Crear la tabla inicialmente con las evidencias de la base de datos
        fetchEvidences().then(evidences => {
            createTable(evidences);
        });
    </script>
</body>
<footer>
    <p>&copy; 2024 - Desenvolupat per <a href="https://juatafe.github.io" target="_blank">Juan Bautista Talens Felis</a></p>
</footer>
</html>